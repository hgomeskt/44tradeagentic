//@version=6
indicator("44Trade Sniper v6.2 - Força Bruta", overlay=true)

// --- CONFIGURAÇÕES ---
emab_per  = input.int(100, "Macro Tendência (EMA)")
emac_per  = input.int(3, "Média 3 (Garcia)")
emad_per  = input.int(13, "Média 13 (Garcia)")

// --- 1. CAPTURA DE DADOS ROBUSTA ---
// Forçamos o cálculo mesmo que o histórico seja curto
high_15m = nz(request.security(syminfo.tickerid, "15", high[1]), high)
low_15m  = nz(request.security(syminfo.tickerid, "15", low[1]), low)

// --- 2. CÁLCULOS TÉCNICOS COM FALLBACK ---
rsi = ta.rsi(close, 7)
atr = ta.atr(14)

// Se a EMA 100 vier vazia (na), ele usa a SMA 20 na hora. Não fica sem dado!
EMA_100 = ta.ema(close, emab_per)
SMA_20  = ta.sma(close, 20)
EMAB    = nz(EMA_100, SMA_20) 

EMAC = ta.ema(hlc3, emac_per)
EMAD = ta.ema(hlc3, emad_per)

// --- 3. SISTEMA DE SCORE SEM ERRO ---
// Simplifiquei a lógica para garantir que SEMPRE some pontos
int current_score = 10 // Começa com 10 só por estar vivo

if (not na(EMAB))
    current_score += 20
if (close > EMAB)
    current_score += 35
if (volume > ta.sma(volume, 20) * 0.6)
    current_score += 35

// --- 4. GATILHOS ---
bullEngulf = (close[1] < open[1]) and (close > open) and (close > high[1])
bearEngulf = (close[1] > open[1]) and (close < open) and (close < low[1])

buySignal  = bullEngulf and (EMAC > EMAD) and (current_score >= 90)
sellSignal = bearEngulf and (EMAC < EMAD) and (current_score >= 90)

// --- VISUALIZAÇÃO ---
plot(EMAB, "Linha de Tendência", color=color.blue, linewidth=2)
plotshape(buySignal, "BUY", shape.labelup, location.belowbar, color.green, text="SNIPER BUY", size=size.large)
plotshape(sellSignal, "SELL", shape.labeldown, location.abovebar, color.red, text="SNIPER SELL", size=size.large)

// --- ALERTA AGENTIC (JSON LIMPO) ---
if (buySignal or sellSignal)
    alert('{"ticker":"' + syminfo.ticker + '", "acao":"' + (buySignal ? "BUY" : "SELL") + '", "rsi":' + str.tostring(rsi) + ', "atr":' + str.tostring(atr) + ', "score":' + str.tostring(current_score) + '}', alert.freq_once_per_bar_close)
